#!/bin/bash

# Install required packages
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# Add Docker repo
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# Install Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io

# Start and enable Docker
sudo systemctl enable docker
sudo systemctl start docker

# Add user to docker group
sudo usermod -aG docker $USER

# Enable and start Docker
sudo systemctl enable docker
sudo systemctl start docker

# Stop firewalld if it's installed
if systemctl list-unit-files | grep -q firewalld.service; then
  sudo systemctl stop firewalld || true
fi

# Create app files
cd /home/opc
echo '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>marksome.no</title>
</head>
<body>
    <h1>Hello, marksome.no!</h1>
    <p>This is a simple web server running inside a Docker container.</p>
</body>
</html>' > index.html
echo -e 'FROM nginx:alpine\nCOPY index.html /usr/share/nginx/html/ \nEXPOSE 80\nCMD ["nginx", "-g", "daemon off;"]' > Dockerfile

# Ensure Dockerfile exists
if [ -f Dockerfile ]; then
  docker build -t webserver .
  docker run -d -p 80:80 --name webserver webserver
else
  echo "No Dockerfile found in home directory. Skipping build and run."
fi